<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Community Help Portal</title>
<style>
  /* Reset & Variables */
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#f8f9fa;--card:#fff;--text:#111827;--muted:#6b7280;
    --primary:#0b5cff;--success:#16a34a;--danger:#dc2626;--accent:#f59e0b;
    --glass: rgba(255,255,255,0.6);
  }
  [data-theme="dark"]{
    --bg:#0b1220;--card:#0f1724;--text:#e6eef8;--muted:#94a3b8;
    --glass: rgba(255,255,255,0.03);
  }
  body{font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text);padding:18px;line-height:1.4}
  .container{max-width:1100px;margin:auto}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  h1{font-size:1.3rem}
  .controls{display:flex;gap:8px;align-items:center}
  button,select,input,textarea{font:inherit}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .form-row{display:flex;gap:8px;margin-bottom:10px}
  .form-row .field{flex:1}
  label{display:block;font-size:0.78rem;color:var(--muted);margin-bottom:6px}
  input[type=text], input[type=tel], input[type=email], select, textarea{
    width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--text)
  }
  textarea{min-height:100px;resize:vertical}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;background:var(--primary);color:white;cursor:pointer;transition:0.2s}
  .btn:hover{opacity:0.9}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,92,255,0.12)}
  .btn.danger{background:var(--danger)}
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-size:0.75rem;background:rgba(0,0,0,0.04);color:var(--muted)}
  .urgency-high{background:rgba(220,38,38,0.12);color:var(--danger)}
  .urgency-med{background:rgba(245,158,11,0.12);color:var(--accent)}
  .urgency-low{background:rgba(16,185,129,0.08);color:var(--success)}
  .request-list{display:grid;gap:12px}
  .request-card{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--glass);transition:0.2s}
  .request-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.08)}
  .request-card.resolved{opacity:0.5;text-decoration:line-through}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .meta .left{display:flex;flex-direction:column;gap:4px}
  .meta .right{display:flex;gap:8px;align-items:center}
  .small{font-size:0.78rem;color:var(--muted)}
  .footer-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:20px;transition:0.2s}
  .modal-backdrop.show{display:flex;opacity:1}
  .modal{background:var(--card);padding:14px;border-radius:12px;max-width:480px;width:100%;transition:0.3s;transform:translateY(-20px);opacity:0}
  .modal.show{transform:translateY(0);opacity:1}
  .stats{display:flex;gap:10px;flex-wrap:wrap}
  .stat{flex:1;min-width:130px;padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent)}
  .muted-block{color:var(--muted)}
</style>
</head>
<body>
<div class="container" id="app">
<header>
  <div>
    <h1>Community Help Request Portal</h1>
    <div class="small">Submit or browse help requests from your community.</div>
  </div>
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Search requests..." class="small" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.12)">
    <button class="btn ghost" id="refreshBtn" title="Reload requests">Refresh</button>
    <label style="display:flex;align-items:center;gap:8px">
      <span class="small">Theme</span>
      <select id="themeSel" aria-label="Theme select">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </label>
  </div>
</header>

<main class="grid">
<section>
  <div class="card" aria-labelledby="submitTitle">
    <h2 id="submitTitle">Submit a Help Request</h2>
    <form id="requestForm">
      <div class="form-row">
        <div class="field">
          <label for="name">Name</label>
          <input id="name" name="name" type="text" required placeholder="Your name" />
        </div>
        <div class="field">
          <label for="contact">Contact</label>
          <input id="contact" name="contact" type="text" required placeholder="Email or phone" />
        </div>
      </div>
      <div class="form-row">
        <div class="field">
          <label for="type">Request Type</label>
          <select id="type" name="type" required>
            <option value="Medical">Medical</option>
            <option value="Education">Education</option>
            <option value="Infrastructure">Infrastructure</option>
            <option value="Emergency">Emergency</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="field">
          <label for="urgency">Urgency</label>
          <select id="urgency" name="urgency" required>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:8px">
        <label for="desc">Description</label>
        <textarea id="desc" name="desc" required placeholder="Describe the help needed..."></textarea>
      </div>
      <div class="flex">
        <button class="btn" type="submit">Submit Request</button>
        <button class="btn ghost" type="button" id="clearBtn">Clear Form</button>
      </div>
      <div id="formMsg" class="small" style="margin-top:8px"></div>
    </form>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <h3>Statistics</h3>
    <div class="stats" id="stats"></div>
  </div>
</section>

<aside>
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center">
      <label class="small">Filter</label>
      <select id="filterType" aria-label="Filter by type">
        <option value="All">All</option>
        <option value="Medical">Medical</option>
        <option value="Education">Education</option>
        <option value="Infrastructure">Infrastructure</option>
        <option value="Emergency">Emergency</option>
        <option value="Other">Other</option>
      </select>
      <label class="small right">Sort</label>
      <select id="sortBy" aria-label="Sort requests">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="urgency">Urgency</option>
        <option value="helpers">Helpers</option>
      </select>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <h3>Requests</h3>
    <div id="requestCount" class="small muted-block">No requests yet</div>
    <div class="request-list" id="requests"></div>
  </div>
</aside>
</main>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h3 id="modalTitle">Offer Help</h3>
    <form id="helperForm">
      <input type="hidden" id="targetId" />
      <div>
        <label for="helperName">Your Name</label>
        <input id="helperName" required />
      </div>
      <div style="margin-top:8px">
        <label for="helperContact">Contact</label>
        <input id="helperContact" required />
      </div>
      <div style="margin-top:8px">
        <label for="statusSel">Set Status (optional)</label>
        <select id="statusSel">
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
        </select>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button type="button" class="btn ghost" id="closeModal">Cancel</button>
        <button type="submit" class="btn">Send</button>
      </div>
      <div id="modalMsg" class="small" style="margin-top:8px"></div>
    </form>
  </div>
</div>

<script>
/********** Modular SPA Logic **********/
class RequestManager {
  constructor() {
    this.LS_KEY = 'community_help_requests_v2';
    this.requests = [];
    this.cacheDom();
    this.loadRequests();
    this.seedIfEmpty();
    this.bindEvents();
    this.render();
    this.renderStats();
    this.initTheme();
  }

  cacheDom() {
    this.form = document.getElementById('requestForm');
    this.nameInp = document.getElementById('name');
    this.contactInp = document.getElementById('contact');
    this.typeSel = document.getElementById('type');
    this.urgencySel = document.getElementById('urgency');
    this.descInp = document.getElementById('desc');
    this.formMsg = document.getElementById('formMsg');
    this.requestsNode = document.getElementById('requests');
    this.requestCount = document.getElementById('requestCount');
    this.filterType = document.getElementById('filterType');
    this.sortBy = document.getElementById('sortBy');
    this.statsNode = document.getElementById('stats');
    this.modalBackdrop = document.getElementById('modalBackdrop');
    this.helperForm = document.getElementById('helperForm');
    this.targetId = document.getElementById('targetId');
    this.helperName = document.getElementById('helperName');
    this.helperContact = document.getElementById('helperContact');
    this.statusSel = document.getElementById('statusSel');
    this.modalMsg = document.getElementById('modalMsg');
    this.themeSel = document.getElementById('themeSel');
    this.searchInput = document.getElementById('searchInput');
  }

  uid() { return 'r_'+Math.random().toString(36).slice(2,9); }
  nowISO() { return new Date().toISOString(); }

  loadRequests() {
    const raw = localStorage.getItem(this.LS_KEY);
    this.requests = raw ? JSON.parse(raw) : [];
  }

  saveRequests() {
    localStorage.setItem(this.LS_KEY, JSON.stringify(this.requests));
  }

  seedIfEmpty() {
    if(this.requests.length===0) {
      this.requests = [
        {id:this.uid(), name:'Rita Sharma', contact:'+91 98xxxx', type:'Medical', desc:'Needs transport to clinic', urgency:'High', date:this.nowISO(), helpers:[], status:'Open'},
        {id:this.uid(), name:'Sunil Kumar', contact:'sunil@mail', type:'Education', desc:'Volunteer teacher needed', urgency:'Medium', date:this.nowISO(), helpers:[], status:'Open'}
      ];
      this.saveRequests();
    }
  }

  bindEvents() {
    this.form.addEventListener('submit', e=>this.addRequest(e));
    document.getElementById('clearBtn').addEventListener('click', ()=>{ this.form.reset(); this.formMsg.textContent='Form cleared'; this.formMsg.style.color='var(--muted)'; });
    this.filterType.addEventListener('change', ()=>this.render());
    this.sortBy.addEventListener('change', ()=>this.render());
    document.getElementById('refreshBtn').addEventListener('click', ()=>{ this.loadRequests(); this.render(); this.renderStats(); });
    this.searchInput.addEventListener('input', ()=>this.render());
    document.getElementById('closeModal').addEventListener('click', ()=>this.closeModal());
    this.modalBackdrop.addEventListener('click', e=>{ if(e.target===this.modalBackdrop) this.closeModal(); });
    this.helperForm.addEventListener('submit', e=>this.submitHelper(e));
    this.themeSel.addEventListener('change', ()=>{ localStorage.setItem('chp_theme', this.themeSel.value); this.applyTheme(this.themeSel.value); });
  }

  addRequest(e) {
    e.preventDefault();
    const val = { id:this.uid(), name:this.nameInp.value.trim(), contact:this.contactInp.value.trim(), type:this.typeSel.value, desc:this.descInp.value.trim(), urgency:this.urgencySel.value, date:this.nowISO(), helpers:[], status:'Open'};
    if(!val.name||!val.contact||!val.desc){ this.formMsg.textContent='Please fill all fields.'; this.formMsg.style.color='var(--danger)'; return; }
    this.requests.push(val); this.saveRequests();
    this.formMsg.textContent='Request submitted successfully!'; this.formMsg.style.color='var(--success)';
    this.form.reset();
    this.render();
    this.renderStats();
    this.nameInp.focus();
  }

  urgencyRank(u){ return u==='High'?3:u==='Medium'?2:1; }
  urgencyClass(u){ return u==='High'?'urgency-high':u==='Medium'?'urgency-med':'urgency-low'; }

  escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

  render() {
    let list = [...this.requests];
    const f = this.filterType.value;
    const search = this.searchInput.value.toLowerCase();
    if(f!=='All') list = list.filter(r=> r.type===f);
    if(search) list = list.filter(r=> r.name.toLowerCase().includes(search) || r.desc.toLowerCase().includes(search));
    const s = this.sortBy.value;
    if(s==='newest') list.sort((a,b)=> new Date(b.date)-new Date(a.date));
    if(s==='oldest') list.sort((a,b)=> new Date(a.date)-new Date(b.date));
    if(s==='urgency') list.sort((a,b)=> this.urgencyRank(b.urgency)-this.urgencyRank(a.urgency));
    if(s==='helpers') list.sort((a,b)=> (b.helpers?.length||0) - (a.helpers?.length||0));

    this.requestsNode.innerHTML='';
    if(list.length===0){ this.requestCount.textContent='No requests found.'; return; }
    this.requestCount.textContent=list.length+' request(s)';

    list.forEach(r=>{
      const div = document.createElement('div'); div.className='request-card'+(r.status==='Resolved'?' resolved':'');
      const meta = document.createElement('div'); meta.className='meta';
      const left = document.createElement('div'); left.className='left';
      const title = document.createElement('div'); title.innerHTML=`<strong>${this.escapeHtml(r.name)}</strong> <span class="small">• ${this.escapeHtml(r.type)}</span>`;
      const badges = document.createElement('div'); badges.className='flex';
      const urg = document.createElement('span'); urg.className='badge '+this.urgencyClass(r.urgency); urg.textContent=r.urgency;
      const status = document.createElement('span'); status.className='badge'; status.textContent=r.status||'Open';
      badges.appendChild(urg); badges.appendChild(status);
      left.appendChild(title); left.appendChild(badges);

      const right = document.createElement('div'); right.className='right';
      const date = document.createElement('div'); date.className='small'; date.textContent=new Date(r.date).toLocaleString();
      right.appendChild(date);
      meta.appendChild(left); meta.appendChild(right);

      const desc = document.createElement('div'); desc.textContent=r.desc;

      const foot = document.createElement('div'); foot.className='footer-row';
      const helperInfo = document.createElement('div'); helperInfo.className='small'; helperInfo.textContent=`Helpers: ${ (r.helpers||[]).length }`;
      const buttons = document.createElement('div'); buttons.className='flex';
      const offerBtn = document.createElement('button'); offerBtn.className='btn ghost'; offerBtn.textContent='Offer Help'; offerBtn.onclick=()=>this.openModal(r.id);
      const statusBtn = document.createElement('button'); statusBtn.className='btn ghost'; statusBtn.textContent='Edit Status'; statusBtn.onclick=()=>this.openModal(r.id,true);
      buttons.appendChild(offerBtn); buttons.appendChild(statusBtn);
      foot.appendChild(helperInfo); foot.appendChild(buttons);

      div.appendChild(meta); div.appendChild(desc); div.appendChild(foot);
      this.requestsNode.appendChild(div);
    });
  }

  renderStats() {
    const total = this.requests.length;
    const byType = this.requests.reduce((acc,r)=>{ acc[r.type]=(acc[r.type]||0)+1; return acc; },{});
    const helpers = this.requests.reduce((acc,r)=> acc+(r.helpers?.length||0),0);
    const resolved = this.requests.filter(r=>r.status==='Resolved').length;
    this.statsNode.innerHTML='';
    this.statsNode.appendChild(this.makeStat('Total Requests', total));
    ['Medical','Education','Infrastructure','Emergency','Other'].forEach(t=>this.statsNode.appendChild(this.makeStat(t, byType[t]||0)));
    this.statsNode.appendChild(this.makeStat('Total Helpers', helpers));
    this.statsNode.appendChild(this.makeStat('Resolved Requests', resolved));
  }

  makeStat(title,value){ const d=document.createElement('div'); d.className='stat'; d.innerHTML=`<div class="small">${title}</div><div style="font-weight:700;font-size:1.1rem">${value}</div>`; return d; }

  openModal(id,setStatusOnly=false) {
    this.modalBackdrop.classList.add('show');
    const modal = this.modalBackdrop.querySelector('.modal'); modal.classList.add('show');
    this.targetId.value=id;
    this.modalMsg.textContent='';
    if(setStatusOnly){
      document.getElementById('modalTitle').textContent='Edit Request Status';
      this.helperName.parentElement.style.display='none';
      this.helperContact.parentElement.style.display='none';
    } else {
      document.getElementById('modalTitle').textContent='Offer Help';
      this.helperName.parentElement.style.display='block';
      this.helperContact.parentElement.style.display='block';
    }
    this.helperName.value=''; this.helperContact.value='';
  }

  closeModal() {
    this.modalBackdrop.classList.remove('show');
    this.modalBackdrop.querySelector('.modal').classList.remove('show');
  }

  submitHelper(e) {
    e.preventDefault();
    const id=this.targetId.value;
    const idx=this.requests.findIndex(r=>r.id===id);
    if(idx===-1){ this.modalMsg.textContent='Request not found.'; return; }
    const rec=this.requests[idx];
    const setStatus=this.statusSel.value||rec.status;
    if(this.helperName.value.trim() && this.helperContact.value.trim()){
      rec.helpers = rec.helpers || [];
      rec.helpers.push({name:this.helperName.value.trim(), contact:this.helperContact.value.trim(), at:this.nowISO()});
      this.modalMsg.textContent='Thanks — your offer is recorded.';
    } else this.modalMsg.textContent='Status updated.';
    rec.status=setStatus;
    this.requests[idx]=rec; this.saveRequests();
    this.render(); this.renderStats();
    setTimeout(()=>this.closeModal(),800);
  }

  initTheme() {
    const saved=localStorage.getItem('chp_theme')||'light'; this.themeSel.value=saved; this.applyTheme(saved);
  }
  applyTheme(t){ if(t==='dark') document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme'); }
}

new RequestManager();
</script>
</body>
</html>

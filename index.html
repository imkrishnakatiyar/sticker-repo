<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Community Help Portal</title>
<style>
  /* ===== Basic Reset ===== */
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#f8f9fa; --card:#ffffff; --text:#111827; --muted:#6b7280;
    --primary:#0b5cff; --success:#16a34a; --danger:#dc2626; --accent:#f59e0b;
    --glass: rgba(255,255,255,0.6);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f1724; --text:#e6eef8; --muted:#94a3b8; --glass: rgba(255,255,255,0.03);
  }
  body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);line-height:1.4;padding:18px;transition:background 0.3s,color 0.3s}
  .container{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px}
  h1{font-size:1.5rem}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select,input,textarea{font:inherit}
  
  /* layout */
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  
  /* Card */
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06);transition:transform 0.2s}
  .card:hover{transform:translateY(-2px)}
  .form-row{display:flex;gap:8px;margin-bottom:10px}
  .form-row .field{flex:1}
  label{display:block;font-size:0.78rem;color:var(--muted);margin-bottom:6px}
  input[type=text], input[type=tel], input[type=email], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--text)}
  textarea{min-height:100px;resize:vertical}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;background:var(--primary);color:white;cursor:pointer;transition:background 0.2s}
  .btn:hover{opacity:0.9}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,92,255,0.12)}
  .btn.danger{background:var(--danger)}
  
  /* badges & tags */
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-size:0.75rem;background:rgba(0,0,0,0.04);color:var(--muted)}
  .urgency-high{background:rgba(220,38,38,0.12);color:var(--danger)}
  .urgency-med{background:rgba(245,158,11,0.12);color:var(--accent)}
  .urgency-low{background:rgba(16,185,129,0.08);color:var(--success)}
  .status-open{background:rgba(59,130,246,0.12);color:#3b82f6}
  .status-progress{background:rgba(251,191,36,0.12);color:#fbbf24}
  .status-resolved{background:rgba(16,185,129,0.12);color:#10b981}
  
  /* request list */
  .request-list{display:grid;gap:12px}
  .request-card{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--glass);position:relative;transition:all 0.3s}
  .request-card.resolved{opacity:0.6;text-decoration:line-through}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .meta .left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .meta .right{display:flex;gap:8px;align-items:center}
  .small{font-size:0.78rem;color:var(--muted)}
  .footer-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:20px;transition:opacity 0.3s}
  .modal-backdrop.show{display:flex;opacity:1}
  .modal{background:var(--card);padding:14px;border-radius:12px;max-width:480px;width:100%;transition:transform 0.3s;transform:translateY(-20px);opacity:0}
  .modal.show{transform:translateY(0);opacity:1}
  .modal h3{margin-bottom:8px}
  
  /* stats */
  .stats{display:flex;gap:10px;flex-wrap:wrap}
  .stat{flex:1;min-width:130px;padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent)}
  
  /* notifications */
  .toast-container{position:fixed;top:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .toast{background:var(--card);padding:10px 14px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.15);transition:all 0.3s;opacity:0;transform:translateX(20px);}
  .toast.show{opacity:1;transform:translateX(0);}
  
  /* tiny helpers */
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .center{display:flex;align-items:center;justify-content:center}
  .hidden{display:none}
  
  /* accessibility focus */
  button:focus, input:focus, select:focus, textarea:focus{outline:3px solid rgba(11,92,255,0.12);outline-offset:2px}
</style>
</head>
<body>
<div class="container" id="app">
<header>
  <div>
    <h1>Community Help Portal</h1>
    <div class="small">Submit or browse help requests from your community.</div>
  </div>
  <div class="controls">
    <button class="btn ghost" id="refreshBtn">Refresh</button>
    <label style="display:flex;align-items:center;gap:8px">
      <span class="small">Theme</span>
      <select id="themeSel" aria-label="Theme select">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </label>
  </div>
</header>

<main class="grid">
  <section>
    <div class="card" aria-labelledby="submitTitle">
      <h2 id="submitTitle">Submit a Help Request</h2>
      <form id="requestForm">
        <div class="form-row">
          <div class="field">
            <label for="name">Name</label>
            <input id="name" name="name" type="text" required placeholder="Your name" />
          </div>
          <div class="field">
            <label for="contact">Contact</label>
            <input id="contact" name="contact" type="text" required placeholder="Email or phone" />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="type">Request Type</label>
            <select id="type" name="type" required>
              <option value="Medical">Medical</option>
              <option value="Education">Education</option>
              <option value="Infrastructure">Infrastructure</option>
              <option value="Emergency">Emergency</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="field">
            <label for="urgency">Urgency</label>
            <select id="urgency" name="urgency" required>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom:8px">
          <label for="desc">Description</label>
          <textarea id="desc" name="desc" required placeholder="Describe the help needed..."></textarea>
        </div>
        <div class="flex">
          <button class="btn" type="submit">Submit Request</button>
          <button class="btn ghost" type="button" id="clearBtn">Clear Form</button>
        </div>
        <div id="formMsg" class="small" style="margin-top:8px"></div>
      </form>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <h3>Statistics</h3>
      <div class="stats" id="stats"></div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <h3>Actions</h3>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost" id="simulateEmail">Simulate Email Alert</button>
        <button class="btn ghost" id="clearAll">Clear All Requests</button>
        
      </div>
      <div class="small" style="margin-top:8px">Clearing all requests will remove them from local storage only.</div>
    </div>
  </section>

  <aside>
    <div class="card">
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">Filter</label>
        <select id="filterType" aria-label="Filter by type">
          <option value="All">All Types</option>
          <option value="Medical">Medical</option>
          <option value="Education">Education</option>
          <option value="Infrastructure">Infrastructure</option>
          <option value="Emergency">Emergency</option>
          <option value="Other">Other</option>
        </select>
        <select id="filterStatus" aria-label="Filter by status">
          <option value="All">All Status</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
        </select>
        <input type="text" id="searchInput" placeholder="Search..." style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.1)">
        <label class="small right">Sort</label>
        <select id="sortBy" aria-label="Sort requests">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="urgency">Urgency</option>
          <option value="helpers">Helpers</option>
        </select>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <h3>Requests</h3>
      <div id="requestCount" class="small muted-block">No requests yet</div>
      <div class="request-list" id="requests"></div>
    </div>
  </aside>
</main>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h3 id="modalTitle">Offer Help</h3>
    <form id="helperForm">
      <input type="hidden" id="targetId" />
      <div>
        <label for="helperName">Your Name</label>
        <input id="helperName" required />
      </div>
      <div style="margin-top:8px">
        <label for="helperContact">Contact</label>
        <input id="helperContact" required />
      </div>
      <div style="margin-top:8px">
        <label for="statusSel">Set Status</label>
        <select id="statusSel">
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
        </select>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button type="button" class="btn ghost" id="closeModal">Cancel</button>
        <button type="submit" class="btn">Send</button>
      </div>
      <div id="modalMsg" class="small" style="margin-top:8px"></div>
    </form>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastContainer"></div>

<script>
(() => {
  const LS_KEY = 'community_help_requests_v2';
  const el = id => document.getElementById(id);
  const uid = ()=> 'r_'+Math.random().toString(36).slice(2,9);
  const nowISO = ()=> new Date().toISOString();

  /* Elements */
  const form = el('requestForm'), nameInp = el('name'), contactInp = el('contact'), typeSel = el('type'), urgencySel = el('urgency'), descInp = el('desc'), formMsg = el('formMsg');
  const requestsNode = el('requests'), requestCount = el('requestCount'), filterType = el('filterType'), filterStatus = el('filterStatus'), sortBy = el('sortBy'), searchInput = el('searchInput');
  const modalBackdrop = el('modalBackdrop'), helperForm = el('helperForm'), targetId = el('targetId'), helperName = el('helperName'), helperContact = el('helperContact'), statusSel = el('statusSel'), modalMsg = el('modalMsg');
  const themeSel = el('themeSel'), statsNode = el('stats'), toastContainer = el('toastContainer');

  let requests = [];

  function showToast(msg, type='success'){
    const t = document.createElement('div'); t.className='toast show'; t.textContent=msg;
    toastContainer.appendChild(t);
    setTimeout(()=>{ t.classList.remove('show'); t.remove(); },3000);
  }

  function loadRequests(){
    try{ const raw = localStorage.getItem(LS_KEY); requests = raw? JSON.parse(raw):[]; } catch(e){ console.error(e); requests=[]; }
  }
  function saveRequests(){ localStorage.setItem(LS_KEY, JSON.stringify(requests)); }

  function urgencyRank(u){ return u==='High'?3:u==='Medium'?2:1; }
  function urgencyClass(u){ return u==='High'?'urgency-high':u==='Medium'?'urgency-med':'urgency-low'; }
  function statusClass(s){ return s==='Open'?'status-open':s==='In Progress'?'status-progress':'status-resolved'; }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

  function render(){
    let list = requests.slice();
    // filter
    if(filterType.value!=='All') list = list.filter(r=>r.type===filterType.value);
    if(filterStatus.value!=='All') list = list.filter(r=>r.status===filterStatus.value);
    const search = searchInput.value.trim().toLowerCase();
    if(search) list = list.filter(r=>r.name.toLowerCase().includes(search)||r.desc.toLowerCase().includes(search)||r.contact.toLowerCase().includes(search));
    // sort
    if(sortBy.value==='newest') list.sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(sortBy.value==='oldest') list.sort((a,b)=>new Date(a.date)-new Date(b.date));
    if(sortBy.value==='urgency') list.sort((a,b)=>urgencyRank(b.urgency)-urgencyRank(a.urgency));
    if(sortBy.value==='helpers') list.sort((a,b)=>(b.helpers?.length||0)-(a.helpers?.length||0));

    requestsNode.innerHTML='';
    if(list.length===0){ requestCount.textContent='No requests found.'; return; }
    requestCount.textContent=list.length+' request(s)';

    list.forEach(r=>{
      const div=document.createElement('div'); div.className='request-card'+(r.status==='Resolved'?' resolved':'');
      const meta=document.createElement('div'); meta.className='meta';
      const left=document.createElement('div'); left.className='left';
      const title=document.createElement('div'); title.innerHTML=`<strong>${escapeHtml(r.name)}</strong> <span class="small">â€¢ ${escapeHtml(r.type)}</span>`;
      const badges=document.createElement('div'); badges.className='flex';
      const urg=document.createElement('span'); urg.className='badge '+urgencyClass(r.urgency); urg.textContent=r.urgency;
      const status=document.createElement('span'); status.className='badge '+statusClass(r.status); status.textContent=r.status;
      badges.appendChild(urg); badges.appendChild(status);
      left.appendChild(title); left.appendChild(badges);
      const right=document.createElement('div'); right.className='right';
      const date=document.createElement('div'); date.className='small'; date.textContent=new Date(r.date).toLocaleString();
      right.appendChild(date);
      meta.appendChild(left); meta.appendChild(right);

      const desc=document.createElement('div'); desc.textContent=r.desc;

      const foot=document.createElement('div'); foot.className='footer-row';
      const helperInfo=document.createElement('div'); helperInfo.className='small'; 
      helperInfo.textContent=`Helpers: ${r.helpers?.length||0}`;
      if(r.helpers?.length>0){
        helperInfo.title=r.helpers.map(h=>`${h.name} (${h.contact})`).join(', ');
      }
      const buttons=document.createElement('div'); buttons.className='flex';
      const offerBtn=document.createElement('button'); offerBtn.className='btn ghost'; offerBtn.textContent='Offer Help';
      offerBtn.onclick=()=> openModal(r.id);
      const statusBtn=document.createElement('button'); statusBtn.className='btn ghost'; statusBtn.textContent='Edit Status';
      statusBtn.onclick=()=> openModal(r.id,true);
      const deleteBtn=document.createElement('button'); deleteBtn.className='btn danger'; deleteBtn.textContent='Delete';
      deleteBtn.onclick=()=>{ if(confirm('Delete this request?')){ requests=requests.filter(x=>x.id!==r.id); saveRequests(); render(); renderStats(); showToast('Request deleted','danger'); }};
      buttons.appendChild(offerBtn); buttons.appendChild(statusBtn); buttons.appendChild(deleteBtn);
      foot.appendChild(helperInfo); foot.appendChild(buttons);

      div.appendChild(meta); div.appendChild(desc); div.appendChild(foot);
      requestsNode.appendChild(div);
    });
  }

  form.addEventListener('submit', e=>{
    e.preventDefault();
    const val={id:uid(),name:nameInp.value.trim(),contact:contactInp.value.trim(),type:typeSel.value,desc:descInp.value.trim(),urgency:urgencySel.value,date:nowISO(),helpers:[],status:'Open'};
    if(!val.name||!val.contact||!val.desc){ formMsg.textContent='Please fill all fields.'; formMsg.style.color='var(--danger)'; return; }
    requests.push(val); saveRequests(); render(); renderStats();
    form.reset(); formMsg.textContent='Request submitted!'; formMsg.style.color='var(--success)'; nameInp.focus();
    showToast('Request submitted');
  });

  el('clearBtn').addEventListener('click', ()=>{ form.reset(); formMsg.textContent='Form cleared'; formMsg.style.color='var(--muted)'; });

  function openModal(id,setStatusOnly=false){
    modalBackdrop.classList.add('show'); el('modal').classList.add('show');
    targetId.value=id; modalMsg.textContent='';
    if(setStatusOnly){ document.getElementById('modalTitle').textContent='Edit Request Status'; helperName.parentElement.style.display='none'; helperContact.parentElement.style.display='none'; }
    else{ document.getElementById('modalTitle').textContent='Offer Help'; helperName.parentElement.style.display='block'; helperContact.parentElement.style.display='block'; }
    helperName.value=''; helperContact.value='';
  }
  function closeModal(){ modalBackdrop.classList.remove('show'); el('modal').classList.remove('show'); }
  el('closeModal').addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', e=>{ if(e.target===modalBackdrop) closeModal(); });

  helperForm.addEventListener('submit', e=>{
    e.preventDefault(); const id=targetId.value; const idx=requests.findIndex(x=>x.id===id); if(idx===-1){ modalMsg.textContent='Request not found'; return; }
    const rec=requests[idx]; const setStatus=statusSel.value||rec.status;
    if(helperName.value.trim() && helperContact.value.trim()){ rec.helpers=rec.helpers||[]; rec.helpers.push({name:helperName.value.trim(),contact:helperContact.value.trim(),at:nowISO()}); showToast('Helper added'); } 
    rec.status=setStatus; requests[idx]=rec; saveRequests(); render(); renderStats(); closeModal();
  });

  filterType.addEventListener('change', render); filterStatus.addEventListener('change', render); sortBy.addEventListener('change', render); searchInput.addEventListener('input', render);

  el('refreshBtn').addEventListener('click', ()=>{ loadRequests(); render(); renderStats(); showToast('Refreshed'); });
  el('simulateEmail').addEventListener('click', ()=>showToast('Simulated email alert to helpers'));

  el('clearAll').addEventListener('click', ()=>{ if(confirm('Clear all requests?')){ requests=[]; saveRequests(); render(); renderStats(); showToast('All requests cleared','danger'); }});

  el('exportJSON').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(requests,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='requests.json'; a.click(); URL.revokeObjectURL(url);
  });
  el('importBtn').addEventListener('click', ()=>el('importJSON').click());
  el('importJSON').addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader(); reader.onload=function(){ try{ requests=JSON.parse(reader.result); saveRequests(); render(); renderStats(); showToast('Data imported'); }catch(err){showToast('Invalid JSON','danger')} };
    reader.readAsText(file);
  });

  function renderStats(){
    const total=requests.length;
    const byType={}; const byStatus={}; let helpers=0;
    requests.forEach(r=>{ byType[r.type]=(byType[r.type]||0)+1; byStatus[r.status]=(byStatus[r.status]||0)+1; helpers+=r.helpers?.length||0; });
    statsNode.innerHTML=''; statsNode.appendChild(makeStat('Total Requests',total));
    ['Medical','Education','Infrastructure','Emergency','Other'].forEach(t=>statsNode.appendChild(makeStat(t,byType[t]||0)));
    ['Open','In Progress','Resolved'].forEach(s=>statsNode.appendChild(makeStat(s,byStatus[s]||0)));
    statsNode.appendChild(makeStat('Total Helpers',helpers));
  }
  function makeStat(title,value){ const d=document.createElement('div'); d.className='stat'; d.innerHTML=`<div class="small">${title}</div><div style="font-weight:700;font-size:1.1rem">${value}</div>`; return d }

  function initTheme(){ const saved=localStorage.getItem('chp_theme')||'light'; themeSel.value=saved; applyTheme(saved); themeSel.addEventListener('change',()=>{ localStorage.setItem('chp_theme',themeSel.value); applyTheme(themeSel.value); }); }
  function applyTheme(t){ if(t==='dark') document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme'); }

  function seedIfEmpty(){ if(requests.length===0){ requests=[{id:uid(),name:'Rita Sharma',contact:'+91 98xxxx',type:'Medical',desc:'Needs transport to clinic',urgency:'High',date:nowISO(),helpers:[],status:'Open'},{id:uid(),name:'Sunil Kumar',contact:'sunil@mail',type:'Education',desc:'Volunteer teacher needed for evening classes',urgency:'Medium',date:nowISO(),helpers:[],status:'Open'}]; saveRequests(); } }

  /* Initialize */
  loadRequests(); seedIfEmpty(); initTheme(); render(); renderStats();
})();
</script>
</body>
</html>

